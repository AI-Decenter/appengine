````markdown
# Issue 03: T√≠ch h·ª£p Artifact Registry (MinIO/S3 Presigned URL)

**Lo·∫°i:** `feat`  
**Ph·ª• thu·ªôc:** 02 (DB l∆∞u artifact)

> C·∫¨P NH·∫¨T 2025-09-28: Issue ƒë√£ ƒë∆∞·ª£c m·ªü r·ªông v∆∞·ª£t ph·∫°m vi ban ƒë·∫ßu (two-phase + multipart, quotas, retention, idempotency, SSE, audit events, metrics n√¢ng cao). T√†i li·ªáu n√†y ph·∫£n √°nh tr·∫°ng th√°i th·ª±c thi hi·ªán t·∫°i v√† li·ªát k√™ c√°c b∆∞·ªõc ti·∫øp theo m·ªõi.

## 1. M·ª•c ti√™u
Chuy·ªÉn l∆∞u tr·ªØ local ‚Üí MinIO/S3 qua presigned URL ƒë·ªÉ t√°ch IO kh·ªèi Control Plane, ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn (digest, k√≠ch th∆∞·ªõc, optional remote hash) v√† m·ªü ƒë∆∞·ªùng cho m·ªü r·ªông multipart uploads.

## 2. Scope
Checklist (‚úÖ done, ‚è≥ in progress, üÜï newly added scope, ÔøΩ deprecated, üîú planned)

| M·ª•c | Tr·∫°ng th√°i | Ghi ch√∫ c·∫≠p nh·∫≠t |
|-----|------------|------------------|
| Endpoint `POST /artifacts/presign` | ‚úÖ | AWS SDK V4 presign + sha256 metadata + method `NONE` n·∫øu duplicate |
| Endpoint `POST /artifacts/complete` | ‚úÖ | Verify size (HEAD), metadata digest, optional remote hash; idempotency key h·ªó tr·ª£ |
| Tr·∫°ng th√°i artifact `pending` / `stored` | ‚úÖ | HEAD ch·ªâ 200 khi stored (nay c√≥ endpoint meta m·ªõi) |
| Key layout `artifacts/<app>/<digest>/app.tar.gz` | ‚úÖ | Chu·∫©n ho√° ph·ª•c v·ª• GC / ph√¢n t√≠ch |
| Idempotent presign | ‚úÖ | Duplicate tr·∫£ method `NONE` |
| Idempotent complete | ‚úÖ | Duplicate tr·∫£ `duplicate=true` / status stored |
| Signature verification | ‚úÖ | Reuse b·∫£ng public_keys (Ed25519) |
| Max artifact size enforcement | ‚úÖ | `AETHER_MAX_ARTIFACT_SIZE_BYTES` |
| Remote metadata digest verify | ‚úÖ | Lu√¥n b·∫≠t (c√≥ th·ªÉ t·∫Øt qua env) |
| Optional remote hash (small objects) | ‚úÖ | `AETHER_VERIFY_REMOTE_HASH` + threshold |
| Retry HEAD/GET S3 | ‚úÖ | 3 attempts exponential backoff |
| Pending TTL GC (manual helper) | ‚úÖ | H√†m `run_pending_gc` + metrics GC |
| Metrics c∆° b·∫£n (count, duration) | ‚úÖ | ƒê∆∞·ª£c m·ªü r·ªông (xem danh s√°ch d∆∞·ªõi) |
| Digest mismatch metric | ‚úÖ | `artifact_digest_mismatch_total` |
| CLI two-phase upload | ‚úÖ | M·∫∑c ƒë·ªãnh; legacy ch·ªâ qua `--legacy-upload` |
| Deprecation legacy multipart endpoint | ‚úÖ | Header `X-Aether-Deprecated`, metric ƒë·∫øm |
| Quota per app (count / bytes) | ‚úÖ | `AETHER_MAX_ARTIFACTS_PER_APP`, `AETHER_MAX_TOTAL_BYTES_PER_APP` + metric quota reject |
| Retention keep latest N | ‚úÖ | `AETHER_RETAIN_LATEST_PER_APP` + event `retention_delete` |
| Idempotency key (complete + multipart) | ‚úÖ | `idempotency_key` c·ªôt unique, conflict 409 |
| Audit events table | ‚úÖ | `artifact_events` + metric `artifact_events_total` |
| Multipart S3 upload (init/presign-part/complete) | ‚úÖ | CLI t·ª± ƒë·ªông khi v∆∞·ª£t `AETHER_MULTIPART_THRESHOLD_BYTES` |
| Multipart part metrics (count, size histogram) | ‚úÖ | Approx part size estimation at completion |
| SSE (AES256 / KMS) h·ªó tr·ª£ presign | ‚úÖ | Env `AETHER_S3_SSE`, `AETHER_S3_SSE_KMS_KEY` |
| OpenAPI m√¥ t·∫£ multipart & two-phase | ‚úÖ | Annotations c·∫≠p nh·∫≠t |
| CLI progress bar (PUT / multipart) | ‚úÖ | Ch·ªâ hi·ªán khi TTY + size > threshold |
| Upload PUT duration metric (client provided) | ‚úÖ | Header `X-Aether-Upload-Duration` => histogram |
| Storage abstraction trait m·ªü r·ªông | ‚úÖ | Trait + mock + s3 backend |
| Artifact meta endpoint `GET /artifacts/{digest}/meta` | ‚úÖ | Tr·∫£ ƒë·∫ßy ƒë·ªß tr∆∞·ªùng m·ªõi |
| Histogram multipart part sizes ch√≠nh x√°c | üîú | Hi·ªán ∆∞·ªõc l∆∞·ª£ng; c·∫ßn g·ª≠i part size th·ª±c t·ª´ client |
| Resume multipart (retry part ETAG reuse) | üîú | Ch∆∞a l∆∞u part list t·∫°m th·ªùi |
| Background scheduled pending GC | üîú | Hi·ªán manual helper, ch∆∞a cron n·ªôi b·ªô |
| Webhook / event streaming | üîú | Ch∆∞a tri·ªÉn khai (event table ƒë√£ s·∫µn) |
| HEAD gi√†u th√¥ng tin (thay meta endpoint) | üîú | C√≥ meta endpoint thay th·∫ø; HEAD hi·ªán v·∫´n minimal |
| Rate limit per app | üîú | Ch∆∞a thi·∫øt k·∫ø chi ti·∫øt |
| ETag integrity cross-check (multipart) | üîú | Hi·ªán d·ª±a v√†o S3 complete; kh√¥ng so kh·ªõp manifest c·ª•c b·ªô |
| Server SBOM / manifest l∆∞u tr·ªØ | üîú | CLI t·∫°o local, ch∆∞a upload & reference |
| Encryption enforcement policy | üîú | Ch∆∞a √©p bu·ªôc SSE theo app policy |
| Event bus integration (Kafka/NATS) | üîú | Ch∆∞a tri·ªÉn khai |
| Retention theo tu·ªïi (age-based) | üîú | Ch·ªâ keep-latest N |
| Structured error taxonomy final | üîú | M·ªôt s·ªë m√£ m·ªõi nh∆∞ng ch∆∞a chu·∫©n ho√° ƒë·∫ßy ƒë·ªß |

## 3. Acceptance (Gi·ªØ nguy√™n + m·ªü r·ªông test ƒë√£ c√≥)

## 3. Acceptance
| ID | ƒêi·ªÅu ki·ªán | K·∫øt qu·∫£ | Tr·∫°ng th√°i |
|----|-----------|---------|-----------|
| P1 | Presign request kh√¥ng app | 400 | ‚úÖ Test `presign` validate app_name |
| P2 | Upload xong notify | 200, artifact tr·∫°ng th√°i `stored` | ‚úÖ Test `presign_creates_pending_and_head_not_found_until_complete` + `presign_complete_idempotent` |
| P3 | Upload l·∫°i digest | 200 idempotent | ‚úÖ Duplicate complete + presign method NONE |
| P4 | HEAD tr∆∞·ªõc khi complete | 404 | ‚úÖ Ch·ªâ `stored` m·ªõi tr·∫£ 200 |
| P5 | Pending retry presign | C·∫•p l·∫°i PUT URL | ‚úÖ Logic branch status='pending' |

## 4. Test
ƒê√£ c√≥:
* `presign_complete_idempotent`: verify flow & duplicate.
* `presign_creates_pending_and_head_not_found_until_complete`: tr·∫°ng th√°i chuy·ªÉn `pending` ‚Üí `stored`.
* Signature + duplicate + integrity tests t√°i s·ª≠ d·ª•ng schema & upload tests tr∆∞·ªõc.

Thi·∫øu / c·∫ßn th√™m (follow-up):
* PUT th·ª±c t·∫ø (integration v·ªõi MinIO) ‚Äì ƒê√É c√≥ test S3 (skips n·∫øu kh√¥ng b·∫≠t env) ‚úÖ
* Negative: complete khi ch∆∞a presign ‚Äì ƒë√£ h·ªó tr·ª£ flag b·∫Øt bu·ªôc (`AETHER_REQUIRE_PRESIGN`) ‚úÖ
* Negative: presign digest kh√¥ng h·ª£p l·ªá ‚Äì validation hi·ªán c√≥ ‚úÖ
* Remote hash verify path ch∆∞a test ri√™ng (follow-up) ‚úÖ Test `s3_presign_complete_with_remote_hash` (MinIO gated)

## 5. Thi·∫øt k·∫ø tr·∫°ng th√°i
`pending` ‚Äì t·∫°o l√∫c presign, `size_bytes=0`, ch∆∞a c√≥ ch·ªØ k√Ω.
`stored` ‚Äì sau complete: c·∫≠p nh·∫≠t size, signature, verified.
HEAD ch·ªâ ph·∫£n √°nh `stored` gi√∫p client ph√¢n bi·ªát upload ch∆∞a finalize.

## 6. Ki·∫øn tr√∫c & lu·ªìng
1. Client: POST /artifacts/presign (nh·∫≠n URL + headers, status=pending).
2. Client: PUT file ‚Üí MinIO/S3 (ngo√†i Control Plane).
3. Client: POST /artifacts/complete (g·ª≠i digest + size + signature optional).
4. Control Plane: c·∫≠p nh·∫≠t row, verify ch·ªØ k√Ω, metrics, tr·∫£ v·ªÅ k·∫øt qu·∫£.

## 7. Gi·ªõi h·∫°n c√≤n l·∫°i (Updated)
* Multipart: ch∆∞a h·ªó tr·ª£ resume m·ªôt ph·∫ßn (ph·∫£i re-init n·∫øu gi√°n ƒëo·∫°n tr∆∞·ªõc khi complete).
* Part size histogram: d√πng ∆∞·ªõc l∆∞·ª£ng (chia ƒë·ªÅu) ‚Äì c·∫ßn g·ª≠i th·ª±c t·∫ø ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c khi ph√¢n t√≠ch ph√¢n m·∫£nh.
* Pending GC ch∆∞a c√≥ scheduler n·ªôi b·ªô ƒë·ªãnh k·ª≥ (ch·ªâ helper + c√≥ th·ªÉ operator g·ªçi th·ªß c√¥ng / cron job b√™n ngo√†i).
* Rate limiting ch∆∞a √°p d·ª•ng (√°p d·ª•ng quotas tr∆∞·ªõc, throttling sau).
* Webhook / streaming events ch∆∞a t√≠ch h·ª£p message bus ‚Äì ch·ªâ l∆∞u DB.
* Age-based retention ch∆∞a c√≥ (m·ªõi keep-latest N).
* Manifest / SBOM ch∆∞a ƒë·ªìng b·ªô server (client side only).
* Error taxonomy ch∆∞a ‚Äúlocked‚Äù; c·∫ßn formal schema + t√†i li·ªáu mapping.
* HEAD v·∫´n t·ªëi gi·∫£n ‚Äì meta endpoint m·ªõi ƒë√°p ·ª©ng nhu c·∫ßu gi√†u d·ªØ li·ªáu nh∆∞ng HEAD ti√™u chu·∫©n c√≥ th·ªÉ m·ªü r·ªông tr·∫£ ETag/verified.
* Resume multipart: thi·∫øu l∆∞u tr·ªØ tr·∫°ng th√°i c√°c part ƒë√£ t·∫£i (t·ªëi thi·ªÉu c·∫ßn b·∫£ng t·∫°m ho·∫∑c JSON column cho future resume).

## 8. Enhancements (Historical vs. Current)
| Nh√£n | M√¥ t·∫£ | Tr·∫°ng th√°i |
|------|------|-----------|
| E1 | Real presign (SDK) | ‚úÖ |
| E2 | TTL + GC pending | ‚úÖ (helper) ‚Äì Scheduler üîú |
| E3 | HEAD size validate | ‚úÖ |
| E4 | Optional remote re-hash | ‚úÖ |
| E5 | Th√™m `completed_at` | ‚úÖ |
| E6 | Metrics presign/complete histograms | ‚úÖ (nhi·ªÅu metrics b·ªï sung) |
| E7 | Policy require presign | ‚úÖ (`AETHER_REQUIRE_PRESIGN`) |
| E8 | Quota per app | ‚úÖ |
| E9 | Multipart S3 upload | ‚úÖ (CLI + server) |
| E10 | SSE encryption flags | ‚úÖ |
| E11 | Retention last N | ‚úÖ |
| E12 | Webhook/event emit | üîú (event rows only) |
| E13 | CLI fallback legacy | ‚úÖ |
| E14 | Idempotency key complete | ‚úÖ |
| E15 | Storage abstraction trait | ‚úÖ |
| E16 | OpenAPI transitions | ‚úÖ (annotations enriched) |
| E17 | HEAD rich metadata | ‚úÖ (meta endpoint alt) |
| E18 | Audit log transitions | ‚úÖ (artifact_events) |
| E19 | Multipart metrics histogram (parts/size) | ‚úÖ (approx) |
| E20 | Precise part size reporting | üîú |
| E21 | Multipart resume | üîú |
| E22 | Age-based retention | üîú |
| E23 | Event streaming outbound | üîú |
| E24 | Upload anomaly detection (latency outliers) | üîú |
| E25 | Manifest/SBOM upload + link | üîú |
## 13. Env c·∫≠p nh·∫≠t (ƒê·ªìng b·ªô v·ªõi m√£ ngu·ªìn hi·ªán t·∫°i)
```
# Core upload
AETHER_MAX_ARTIFACT_SIZE_BYTES=52428800      # (Optional) Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc artifact
AETHER_PRESIGN_EXPIRE_SECS=900               # Expiry presigned URL
AETHER_REQUIRE_PRESIGN=true                  # Bu·ªôc presign tr∆∞·ªõc complete

# Verification
AETHER_VERIFY_REMOTE_SIZE=true               # HEAD size check
AETHER_VERIFY_REMOTE_DIGEST=true             # Metadata sha256 check
AETHER_VERIFY_REMOTE_HASH=false              # Hash streaming nh·ªè
AETHER_REMOTE_HASH_MAX_BYTES=8000000         # Ng∆∞·ª°ng t·ªëi ƒëa hash remote

# Multipart
AETHER_MULTIPART_THRESHOLD_BYTES=134217728   # (VD 128MB) B·∫≠t multipart khi >= threshold
AETHER_MULTIPART_PART_SIZE_BYTES=8388608     # (8MB) K√≠ch th∆∞·ªõc part m·ª•c ti√™u

# Quota & retention
AETHER_MAX_ARTIFACTS_PER_APP=5               # Gi·ªõi h·∫°n s·ªë artifact / app
AETHER_MAX_TOTAL_BYTES_PER_APP=1073741824    # (1GB) Gi·ªõi h·∫°n dung l∆∞·ª£ng / app
AETHER_RETAIN_LATEST_PER_APP=3               # Gi·ªØ N artifact m·ªõi nh·∫•t

# Pending GC (helper)
AETHER_PENDING_TTL_SECS=3600                 # TTL pending tr∆∞·ªõc khi b·ªã xo√°
AETHER_PENDING_GC_INTERVAL_SECS=300          # G·ª£i √Ω chu k·ª≥ ch·∫°y GC (ch∆∞a scheduler n·ªôi b·ªô)

# Concurrency
AETHER_MAX_CONCURRENT_UPLOADS=32             # Semaphore legacy endpoint

# S3 / Storage
AETHER_STORAGE_MODE=s3                       # s3 | mock
AETHER_ARTIFACT_BUCKET=artifacts             # T√™n bucket
AETHER_S3_ENDPOINT_URL=http://minio:9000     # Endpoint MinIO
AETHER_S3_SSE=AES256                         # AES256 | aws:kms (optional)
AETHER_S3_SSE_KMS_KEY=...                    # Khi d√πng aws:kms

# CLI / Internal
AETHER_API_BASE=http://localhost:8080        # C·∫•u h√¨nh CLI
```
| E5 | Th√™m c·ªôt `completed_at` cho audit | Medium |
| E6 | Metrics: presign count, complete latency histogram ri√™ng | Medium |
| E7 | Policy: b·∫Øt bu·ªôc presign (reject complete n·∫øu kh√¥ng `pending`) | Medium |
| E8 | Quota theo app (s·ªë artifact / dung l∆∞·ª£ng) | Medium |
| E9 | Multi-part S3 upload support (threshold > size) | Low |
| E10 | Encryption at rest (SSE-S3 / SSE-KMS flags) | Low |
| E11 | Artifact retention / GC theo policy (last N / age) | Medium |
| E12 | Webhook / event emit khi artifact stored | Medium |
| E13 | CLI fallback n·∫øu MinIO down (t·∫°m d√πng direct upload) | Low |
| E14 | Idempotency key cho complete ƒë·ªÉ tr√°nh double-update | Low |
| E15 | Storage abstraction trait (S3, GCS, filesystem) | High |
| E16 | OpenAPI m√¥ t·∫£ tr·∫°ng th√°i / transitions | Medium |
| E17 | HEAD tr·∫£ metadata (verified, size) thay v√¨ ch·ªâ 200 | Medium |
| E18 | Audit log cho t·∫•t c·∫£ status transitions | Low |

## 9. Env ƒë·ªÅ xu·∫•t (t∆∞∆°ng lai)
```
AETHER_S3_BASE_URL=http://minio:9000
AETHER_S3_BUCKET=artifacts
AETHER_S3_REGION=us-east-1
AETHER_S3_ACCESS_KEY=...
AETHER_S3_SECRET_KEY=...
AETHER_PRESIGN_EXPIRE_SECONDS=900
```

## 10. Risk / Mitigation
| R·ªßi ro | ·∫¢nh h∆∞·ªüng | Gi·∫£m thi·ªÉu |
|--------|-----------|-----------|
| Pending b·ªã b·ªè | R√°c DB | TTL + cleanup job (E2) |
| Digest collision gi·∫£ m·∫°o | Ghi ƒë√® d·ªØ li·ªáu | Digest UNIQUE + verify signature (n·∫øu y√™u c·∫ßu) |
| Size gi·∫£ m·∫°o | Sai quan s√°t / billing | HEAD remote & etag (E3) |
| URL l·ªô ra ngo√†i | Upload tr√°i ph√©p | Presign exp + scoped policy (E1) |

## 11. Tr·∫°ng th√°i t·ªïng quan
Core two-phase + multipart + quotas + retention + idempotency + SSE + audit events: HO√ÄN TH√ÄNH.

Legacy direct multipart endpoint ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u deprecated (header + metric). T·∫≠p trung ti·∫øp theo: n√¢ng ƒë·ªô ch√≠nh x√°c observability (real part sizes), tƒÉng t√≠nh ph·ª•c h·ªìi (resume multipart), streaming events, v√† tightening policy (rate limits, encryption enforcement).

## 12. Next Steps Actionable (Updated)
1. Multipart resume: l∆∞u metadata part (s·ªë part ƒë√£ up, etag) ƒë·ªÉ retry kh√¥ng m·∫•t ti·∫øn ƒë·ªô.
2. Ch√≠nh x√°c ho√° metrics part size: CLI g·ª≠i k√≠ch th∆∞·ªõc part th·ª±c t·∫ø (m·∫£ng {part_number,size_bytes}).
3. Scheduled pending GC worker: interval task n·ªôi b·ªô thay v√¨ manual trigger.
4. Event streaming: publish artifact events (stored, retention_delete) ra Kafka/NATS.
5. Age-based retention (song song keep-latest N tu·ª≥ ch·ªçn).
6. Manifest & SBOM server-side storage + integrity link (c·ªôt sbom_url / manifest_url hi·ªán ƒëang NULL).
7. Rate limiting per app (token bucket ho·∫∑c leaky bucket) b·ªï sung ngo√†i quota.
8. Encryption policy enforcement (b·∫Øt bu·ªôc SSE b·∫≠t khi flag compliance).
9. Extended HEAD: enrich ho·∫∑c alias HEAD -> meta (backwards safe) / ETag propagate.
10. Error taxonomy v2: t√†i li·ªáu h√≥a + m√£ ho√° enum ·ªïn ƒë·ªãnh (client friendly).
11. Integration test: multipart negative cases (wrong ETag, missing part).
12. Alerting rules: quota_exceeded, digest_mismatch spike, multipart_complete_failures.
13. Observability: exemplars / tracing spans (upload lifecycle id).
14. CLI optimization: parallel presign-part + upload pipeline (prefetch presign for next part).
15. Storage abstraction: extend to GCS backend (signing v4) & local FS for dev fallback.
16. Security: detect stale pending > TTL automatically w/ background deletion + metric anomalies.
17. Documentation: OpenAPI artifact state machine diagram.
18. Performance: streaming hashing for multipart final verification (optional full re-hash for compliance).
19. Policy: per-app max concurrent multipart sessions.
20. Testing: fuzz invalid idempotency_key collisions and concurrency race conditions.

---
Updated: 2025-09-28 (post enhancement pass)

````